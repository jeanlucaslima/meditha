# Stripe Checkout Setup

Follow these steps to configure Stripe for the Método Lux checkout flow. The instructions assume you already have a Stripe account.

## 1. Create the Product and Price
- In the Stripe dashboard, create a **Product** for the Checklist Metodo Lux offer.
- Add a **one-time price** (R$67 as currently displayed on the site).
- Copy the autogenerated `price_xxx` value — this becomes `STRIPE_PRICE_ID`.

## 2. Configure Environment Variables
Add the following variables to both your local `.env` file and the hosting provider (e.g. Vercel). Restart or redeploy after changes.

```
STRIPE_SECRET_KEY=sk_test_...or...sk_live_...
STRIPE_PRICE_ID=price_...
STRIPE_WEBHOOK_SECRET=whsec_...
APP_ORIGIN=https://metodolux.com.br   # use http://localhost:4321 for local dev
```

The checkout API (`src/pages/api/checkout/create.ts`) reads these values to create Stripe Sessions, so missing/incorrect values will block purchases.

## 3. Local Development Webhooks
Stripe must deliver webhooks to complete fulfillment locally.

```bash
stripe listen --forward-to http://localhost:4321/api/stripe/webhook
```

- The CLI prints a signing secret (`whsec_…`). Paste it into `STRIPE_WEBHOOK_SECRET`.
- Keep the CLI running while testing payments locally.

## 4. Production Webhook
- In Stripe **Developers → Webhooks**, create an endpoint pointing to:
  ```
  https://metodolux.com.br/api/stripe/webhook
  ```
- Subscribe to at least:
  - `checkout.session.completed`
  - `payment_intent.succeeded` (optional safety net)
- Copy the signing secret to the production `STRIPE_WEBHOOK_SECRET`.

## 5. Test the Flow
1. Complete the quiz to generate a session and land on `/durma/checkout` (or append `?session=<uuid>` for testing).
2. Click “Pagar com segurança via Stripe” to create a session via `/api/checkout/create`.
3. After Stripe Checkout, confirm you are redirected to `/durma/sucesso`.
4. Inspect Supabase tables (`checkout_intents`, `stripe_checkout`, `payments`) to verify records.

## 6. Support Contact
Update the placeholder WhatsApp number in `src/pages/durma/checkout.astro` with your real support line before launch.

---

Need more help? Check Stripe’s docs: https://stripe.com/docs/payments/checkout/how-checkout-works
