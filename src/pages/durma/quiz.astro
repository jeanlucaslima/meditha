---
import BaseLayout from '../../layouts/BaseLayout.astro';
import QuizEngine from '../../components/quiz/QuizEngine.tsx';
import QuizEngineSimple from '../../components/quiz/QuizEngineSimple.tsx';
import '../../components/quiz/quiz-styles-updated.css';

// SEO Data
const title = 'Quiz Durma Naturalmente | Método Lux - Descubra seu perfil de sono';
const description = 'Teste de 1 minuto para identificar o que está sabotando seu sono e receber um plano personalizado para dormir naturalmente.';

// Schema.org structured data
const schema = {
  '@context': 'https://schema.org',
  '@graph': [
    {
      '@type': 'WebPage',
      '@id': 'https://metodolux.com.br/durma/quiz',
      url: 'https://metodolux.com.br/durma/quiz',
      name: title,
      description: description,
      inLanguage: 'pt-BR',
      isPartOf: {
        '@type': 'WebSite',
        '@id': 'https://metodolux.com.br',
        name: 'Método Lux',
        description: 'Dormir Natural',
        inLanguage: 'pt-BR'
      }
    },
    {
      '@type': 'Quiz',
      name: 'Quiz Dormir Naturalmente',
      description: 'Avaliação personalizada para identificar problemas do sono e criar plano de tratamento natural',
      author: {
        '@type': 'Organization',
        name: 'Método Lux'
      },
      about: {
        '@type': 'Thing',
        name: 'Qualidade do Sono',
        description: 'Avaliação de problemas relacionados ao sono e insônia'
      },
      educationalLevel: 'Beginner',
      timeRequired: 'PT1M',
      interactivityType: 'active',
      learningResourceType: 'assessment'
    },
    {
      '@type': 'BreadcrumbList',
      itemListElement: [
        {
          '@type': 'ListItem',
          position: 1,
          name: 'Home',
          item: 'https://metodolux.com.br'
        },
        {
          '@type': 'ListItem',
          position: 2,
          name: 'Durma Melhor',
          item: 'https://metodolux.com.br/durma'
        },
        {
          '@type': 'ListItem',
          position: 3,
          name: 'Quiz',
          item: 'https://metodolux.com.br/durma/quiz'
        }
      ]
    }
  ]
};
---

<BaseLayout
  title={title}
  description={description}
  schema={schema}
>
  <!-- Quiz Container -->
  <div class="quiz-page">
    <!-- Original Quiz Engine -->
    <QuizEngine client:load />
    
    <!-- Simple Quiz Engine Test (for debugging if needed) -->
    <!-- <QuizEngineSimple client:load /> -->
  </div>
</BaseLayout>



<style>
  /* Quiz Page Styles */
  .quiz-page {
    min-height: 100vh;
    background: linear-gradient(135deg, var(--color-base-100) 0%, #fefefe 100%);
  }

  /* Global Quiz Styles */
  :global(.quiz-shell) {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Progress Bar Styles */
  :global(.quiz-progress-bar) {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(8px);
    z-index: 100;
    display: flex;
    align-items: center;
    padding: 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  :global(.quiz-progress-bg) {
    flex: 1;
    height: 4px;
    background: var(--color-base-300);
    border-radius: 2px;
    overflow: hidden;
  }

  :global(.quiz-progress-fill) {
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-secondary) 100%);
    border-radius: 2px;
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  :global(.quiz-progress-text) {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    font-weight: 600;
    color: var(--color-primary);
    background: rgba(255, 255, 255, 0.9);
    padding: 4px 8px;
    border-radius: 12px;
    backdrop-filter: blur(4px);
  }

  /* Main Content */
  :global(.quiz-main) {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 80px 16px 32px;
    min-height: 100vh;
  }

  :global(.quiz-container) {
    width: 100%;
    max-width: 640px;
    margin: 0 auto;
    position: relative;
  }

  /* Form Styles */
  :global(.quiz-form) {
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--color-base-300);
    overflow: hidden;
  }

  /* Step Content */
  :global(.quiz-content) {
    padding: 32px;
    min-height: 400px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  :global(.quiz-step-content) {
    max-width: 100%;
  }

  /* Typography */
  :global(.quiz-title) {
    font-size: 24px;
    font-weight: 700;
    line-height: 1.3;
    color: var(--color-primary);
    margin: 0 0 16px;
    text-align: center;
  }

  :global(.quiz-description) {
    font-size: 16px;
    line-height: 1.5;
    color: var(--color-base-content);
    margin: 0 0 32px;
    text-align: center;
    opacity: 0.8;
  }

  /* Options Styles */
  :global(.quiz-options) {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin: 0;
  }

  :global(.quiz-option) {
    display: block;
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: var(--radius);
    border: 2px solid var(--color-base-300);
    background: white;
    position: relative;
    overflow: hidden;
  }

  :global(.quiz-option:hover) {
    border-color: var(--color-secondary);
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
  }

  :global(.quiz-option-selected) {
    border-color: var(--color-primary);
    background: var(--color-primary-50);
  }

  :global(.quiz-option-disabled) {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  :global(.quiz-option-input) {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  :global(.quiz-option-content) {
    display: flex;
    align-items: center;
    padding: 16px;
    gap: 12px;
    min-height: 44px;
  }

  /* Radio/Checkbox Indicators */
  :global(.quiz-option-radio),
  :global(.quiz-option-checkbox) {
    width: 20px;
    height: 20px;
    border: 2px solid var(--color-base-300);
    border-radius: 50%;
    background: white;
    position: relative;
    flex-shrink: 0;
    transition: all 0.2s ease;
  }

  :global(.quiz-option-checkbox) {
    border-radius: 4px;
  }

  :global(.quiz-option-selected .quiz-option-radio::after) {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 8px;
    height: 8px;
    background: var(--color-primary);
    border-radius: 50%;
    transform: translate(-50%, -50%);
  }

  :global(.quiz-option-selected .quiz-option-checkbox::after) {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--color-primary);
    font-weight: bold;
    font-size: 12px;
  }

  :global(.quiz-option-selected .quiz-option-radio),
  :global(.quiz-option-selected .quiz-option-checkbox) {
    border-color: var(--color-primary);
  }

  :global(.quiz-option-label) {
    font-size: 16px;
    line-height: 1.4;
    color: var(--color-base-content);
    flex: 1;
  }

  /* Navigation */
  :global(.quiz-navigation) {
    display: flex;
    gap: 12px;
    padding: 24px 32px;
    background: var(--color-base-100);
    border-top: 1px solid var(--color-base-300);
    justify-content: space-between;
  }

  :global(.quiz-btn) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 12px 24px;
    border-radius: var(--radius);
    font-size: 16px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
    min-height: 44px;
    min-width: 120px;
  }

  :global(.quiz-btn-primary) {
    background: var(--color-primary);
    color: white;
    margin-left: auto;
  }

  :global(.quiz-btn-primary:hover:not(:disabled)) {
    background: var(--color-primary-600);
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(46, 80, 119, 0.3);
  }

  :global(.quiz-btn-back) {
    background: transparent;
    color: var(--color-base-content);
    border: 1px solid var(--color-base-300);
  }

  :global(.quiz-btn-back:hover) {
    background: var(--color-base-200);
  }

  :global(.quiz-btn:disabled),
  :global(.quiz-btn-disabled) {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
  }

  /* Step Counter */
  :global(.quiz-step-counter) {
    text-align: center;
    font-size: 14px;
    color: var(--color-base-content);
    opacity: 0.6;
    margin-top: 16px;
  }

  /* Error Styles */
  :global(.quiz-error) {
    background: #fee2e2;
    border: 1px solid #f87171;
    color: #dc2626;
    padding: 12px 16px;
    border-radius: var(--radius);
    margin: 16px 32px 0;
    font-size: 14px;
    text-align: center;
  }

  /* Selection Helper */
  :global(.quiz-selection-helper) {
    margin-top: 16px;
    text-align: center;
  }

  :global(.quiz-helper-text) {
    font-size: 14px;
    color: var(--color-base-content);
    opacity: 0.7;
    margin: 4px 0;
  }

  :global(.quiz-helper-max) {
    font-weight: 600;
    color: var(--color-primary);
    opacity: 1;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    :global(.quiz-content) {
      padding: 24px;
      min-height: 350px;
    }

    :global(.quiz-navigation) {
      padding: 20px 24px;
      flex-direction: column-reverse;
      gap: 8px;
    }

    :global(.quiz-navigation .quiz-btn) {
      width: 100%;
    }

    :global(.quiz-title) {
      font-size: 20px;
    }

    :global(.quiz-progress-text) {
      right: 12px;
      font-size: 11px;
      padding: 3px 6px;
    }

    :global(.quiz-main) {
      padding: 60px 12px 24px;
    }
  }

  /* Screen Reader Only */
  :global(.sr-only) {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Focus Styles */
  :global(.quiz-option:focus-within) {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  :global(.quiz-btn:focus) {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }
</style>

<script>
  // Quiz-specific analytics tracking
  function trackQuizEvent(eventName: string, detail: any) {
    // Send to existing analytics system
    if (window.gtag) {
      window.gtag('event', eventName, detail);
    }

    // Console log in development
    if (import.meta.env.DEV) {
      console.log('[Quiz Analytics]', eventName, detail);
    }
  }

  // Listen for quiz events
  window.addEventListener('quiz_start', (e: CustomEvent) => {
    trackQuizEvent('quiz_start', e.detail);
  });

  window.addEventListener('quiz_step', (e: CustomEvent) => {
    trackQuizEvent('quiz_step', e.detail);
  });

  window.addEventListener('quiz_lead_submitted', (e: CustomEvent) => {
    trackQuizEvent('quiz_lead_submitted', e.detail);
  });

  window.addEventListener('quiz_complete', (e: CustomEvent) => {
    trackQuizEvent('quiz_complete', e.detail);
  });

  window.addEventListener('offer_view', (e: CustomEvent) => {
    trackQuizEvent('offer_view', e.detail);
  });

  window.addEventListener('offer_click', (e: CustomEvent) => {
    trackQuizEvent('offer_click', e.detail);
  });
</script>